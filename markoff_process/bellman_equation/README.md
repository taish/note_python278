##状態価値関数に関するBellman方程式

- 開始状態の価値は期待される次状態の価値と 途中で得られる期待報酬の和に等しい

###方策πのもとでの状態sの価値V^π(Â)
![](https://raw.githubusercontent.com/wiki/taish/markoff_process/latex-image-1.png)

上の式は
> 行動aで状態sからs'へ移動する確率 * 行動aで状態sからs'へ移動した際に得られる報酬

と解釈できる。ゲームを例に考える

## ボードゲーム

| 0 |  |  |  |
|---:|:-------:|:---:|:--|
|  |  | 人 |  |
| |  -　 |  |  |
| |  |  | 0 |


- 格子の各セルは環境の状態
- 各セルで4つの方向に行動可能
- エージェントは各格子上で1方向に1セル分だけ移動
- 格子外への行動は現在位置を変えない
- 各行動は-1の報酬
- 目的地(0)に着いたら終了
---
この場合それぞれの状態の価値をいくらか考える(目的地の価値は0とする)

| v0 | v1 | v2 | v3 |
|---:|:-------:|:---:|:--|
| v1 | v4 | v5 | v2 |
| v2 | v5 | v4 | v1 |
| v3 | v2 | v1 | v0 |

それぞれの状態に名前をつけると
```
# v1 = (-1 + v0) / 4 + (-1 + v1) / 4 + (-1 + v2) / 4 + (-1 + v4) / 4
# v2 = (-1 + v1) / 4 + (-1 + v2) / 4 + (-1 + v3) / 4 + (-1 + v5) / 4
# v3 = 2 * (-1 + v2) / 4 + 2 * (-1 + v3) / 4
# v4 = 2 * (-1 + v1) / 4 + 2 * (-1 + v5) / 4
# v5 = 2 * (-1 + v2) / 4 + 2 * (-1 + v4) / 4
# こういう式になって v0 = 0なので
# 3 * v1 - v2 - v4 +4 = 0
# 3 * v2 - v1 - v3 -v5 + 4 = 0
# v3 - v2 + 2 = 0
# 2 * v4 - v1 - v5 + 2= 0
# 2 * v5 - v2 - v4 + 2= 0
```
IPythonで計算(sympy)

```
>>> from sympy import *
>>> v0, v1, v2, v3, v4, v5 = symbols('v0 v1 v2 v3 v4 v5')
>>> solve([3 * v1 - v2 - v4 +4 , 3 * v2 - v1 - v3 -v5 + 4, v3 - v2 + 2, 2 * v4 - v1 - v5 + 2, 2 * v5 - v2 - v4 + 2], [v0, v1, v2, v3, v4, v5])
{v₁: -14, v₂: -20, v₃: -22, v₄: -18, v₅: -20}
```


| 0 | -14 | -20 | -22 |
|---:|:-------:|:---:|:--|
| -14 | -18 | -20 | -20 |
| -20 | -20 | -18 | -14 |
| -22 | -20 | -14 | 0 |


という価値となる。もう一つ同じような例で

---


| v0 | v1 | v2 | v3 |
|---:|:-------:|:---:|:--|
| v1 | v4 | v5 | v6 |
| v2 | v5 | v7 | v8 |
| v3 | v6 | v8 | v9 |


- 右下は報酬10で終了
- 左上は報酬0で終了
- 各移動についての報酬は0
---


こんどはこうなる
```
# 3v1 - v2 - v4 = 0
# 3v2 - v1 - v3 - v5 = 0
# 2v3 - v2 - v6 = 0
# 2v4 - v1 - v5 = 0
# 4v5 - v2 - v4 - v6 -v7 = 0
# 3v6 -v3 - v5 -v8 = 0
# 2v7 - v5 - v8 = 0
# 3v8 - v6 -v7 = 10
```

次は行列を使って解く
```
(v1),     ( 3, -1,  0, -4,  0,  0,  0,  0),        (0),
(v2),     (-1,  3, -1,  0, -1,  0,  0,  0),        (0),
(v3),     ( 0, -1,  2,  0,  0, -1,  0,  0),        (0),
(v4),  *  (-1,  0,  0,  2, -1,  0,  0,  0),   =    (0),
(v5),     ( 0, -1,  0, -1,  4, -1, -1,  0),        (0),
(v6),     ( 0,  0, -1,  0, -1,  3,  0, -1),        (0),
(v7),     ( 0,  0,  0,  0, -5,  0,  2, -1),        (0),
(v8)      ( 0,  0,  0,  0,  0, -1, -1,  3)         (10)
```

上のような行列の式になるので

```
```
